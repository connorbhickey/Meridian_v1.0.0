name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.13"
          cache: pip

      - name: Install package + PyInstaller
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"
          pip install hmmlearn pyinstaller

      - name: Build executable
        run: pyinstaller meridian.spec --noconfirm

      - name: Create ZIP archive
        run: Compress-Archive -Path dist/Meridian/* -DestinationPath Meridian-${{ github.ref_name }}-windows.zip
        shell: pwsh

      - name: Generate changelog
        id: changelog
        run: |
          $prev = git describe --tags --abbrev=0 HEAD^ 2>$null
          if ($prev) {
            $log = git log "$prev..HEAD" --pretty=format:"- %s" --no-merges
          } else {
            $log = git log --pretty=format:"- %s" --no-merges -20
          }
          $log | Out-File -FilePath changelog.txt -Encoding utf8
        shell: pwsh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          body_path: changelog.txt
          files: Meridian-${{ github.ref_name }}-windows.zip
          generate_release_notes: true
